---
import Layout from '@/layouts/PageLayout.astro';
import BlogList from '@/components/blog/List.astro';
import Headline from '@/components/blog/Headline.astro';
import WidgetWrapper from '@/components/ui/WidgetWrapper.astro';
import { fetchPosts } from '@/utils/blog';

export const prerender = true;

const allPosts = await fetchPosts();

// Serializa os posts para uso no client-side (remove Content que não é serializável)
const postsForSearch = allPosts.map((post) => ({
  id: post.id,
  slug: post.slug,
  permalink: post.permalink,
  title: post.title,
  excerpt: post.excerpt || '',
  image: typeof post.image === 'string' ? post.image : post.image?.src || '',
  category: post.category,
  tags: post.tags,
  author: post.author,
  publishDate: post.publishDate.toISOString(),
  updateDate: post.updateDate?.toISOString(),
  readingTime: post.readingTime,
}));

const metadata = {
  title: 'Buscar Notícias',
  description: 'Busque por notícias e artigos no blog da Água São Geraldo',
  robots: {
    index: true,
    follow: true,
  },
};
---

<Layout metadata={metadata}>
  <section class="mx-auto w-full px-6 py-12 sm:px-6 sm:py-16 lg:py-20">
    <Headline class="mb-4!">Buscar Notícias</Headline>

    <WidgetWrapper containerClass="pt-4!" id="busca-page">
      <!-- Campo de busca -->
      <div class="mb-8">
        <form id="search-form" class="flex gap-2" action="/busca" method="get">
          <input
            type="search"
            name="s"
            id="search-input"
            placeholder="Digite sua busca..."
            class="border-agua-primary-blue focus:ring-agua-primary-green w-full rounded-lg border-2 px-4 py-3 text-lg focus:outline-none focus:ring-2"
            autocomplete="off"
          />
          <button
            type="submit"
            class="bg-agua-primary-green hover:bg-agua-primary-green/90 rounded-lg px-6 py-3 font-semibold text-white transition-colors"
          >
            Buscar
          </button>
        </form>
      </div>

      <!-- Resultados -->
      <div id="search-results">
        <p id="search-status" class="text-muted mb-4 text-lg"></p>
        <div id="results-container"></div>
        <p id="no-results" class="hidden py-8 text-center text-lg text-gray-500">
          Nenhum resultado encontrado para sua busca.
        </p>
      </div>

      <!-- Lista inicial (todos os posts, escondida quando há busca) -->
      <div id="initial-list">
        <p class="text-muted mb-4 text-lg">
          Mostrando todas as notícias. Use o campo acima para filtrar.
        </p>
        <BlogList news={allPosts} />
      </div>
    </WidgetWrapper>
  </section>
</Layout>

<script define:vars={{ postsForSearch }}>
  const posts = postsForSearch;

  function normalizeText(text) {
    return text
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '');
  }

  function searchPosts(query) {
    if (!query || query.trim() === '') {
      return [];
    }

    const normalizedQuery = normalizeText(query.trim());
    const queryTerms = normalizedQuery.split(/\s+/).filter((term) => term.length > 1);

    if (queryTerms.length === 0) {
      return [];
    }

    return posts.filter((post) => {
      const searchableText = normalizeText(
        [
          post.title,
          post.excerpt,
          post.category?.title,
          post.tags?.map((t) => t.title).join(' '),
          post.author,
        ]
          .filter(Boolean)
          .join(' '),
      );

      // Todos os termos devem estar presentes
      return queryTerms.every((term) => searchableText.includes(term));
    });
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: 'long',
      year: 'numeric',
    });
  }

  function renderResults(results) {
    const container = document.getElementById('results-container');
    const noResults = document.getElementById('no-results');
    const initialList = document.getElementById('initial-list');
    const searchStatus = document.getElementById('search-status');
    const query = document.getElementById('search-input').value.trim();

    if (!query) {
      container.innerHTML = '';
      noResults.classList.add('hidden');
      initialList.classList.remove('hidden');
      searchStatus.textContent = '';
      return;
    }

    initialList.classList.add('hidden');

    if (results.length === 0) {
      container.innerHTML = '';
      noResults.classList.remove('hidden');
      searchStatus.textContent = `Buscando por "${query}"`;
      return;
    }

    noResults.classList.add('hidden');
    searchStatus.textContent = `${results.length} resultado${results.length !== 1 ? 's' : ''} para "${query}"`;

    container.innerHTML = `
      <ul>
        ${results
          .map(
            (post) => `
          <li class="mb-12 md:mb-20">
            <article class="grid gap-4 md:grid-cols-[280px_1fr] md:gap-8">
              ${
                post.image
                  ? `
                <a href="/${post.permalink}/" class="block overflow-hidden rounded-lg">
                  <img 
                    src="${post.image}" 
                    alt="${post.title}"
                    class="aspect-video w-full object-cover transition-transform duration-300 hover:scale-105"
                    loading="lazy"
                  />
                </a>
              `
                  : ''
              }
              <div class="flex flex-col justify-center">
                ${
                  post.category
                    ? `
                  <span class="text-agua-primary-green mb-2 text-sm font-medium uppercase">
                    ${post.category.title}
                  </span>
                `
                    : ''
                }
                <h2 class="mb-2 text-xl font-bold md:text-2xl">
                  <a href="/${post.permalink}/" class="hover:text-agua-primary-green transition-colors">
                    ${post.title}
                  </a>
                </h2>
                ${post.excerpt ? `<p class="text-muted mb-3 line-clamp-2">${post.excerpt}</p>` : ''}
                <div class="text-muted flex flex-wrap items-center gap-3 text-sm">
                  <time datetime="${post.publishDate}">${formatDate(post.publishDate)}</time>
                  ${post.author ? `<span>• ${post.author}</span>` : ''}
                  ${post.readingTime ? `<span>• ${post.readingTime} min de leitura</span>` : ''}
                </div>
              </div>
            </article>
          </li>
        `,
          )
          .join('')}
      </ul>
    `;
  }

  function init() {
    const searchInput = document.getElementById('search-input');
    const searchForm = document.getElementById('search-form');

    // Pega query da URL
    const urlParams = new URLSearchParams(window.location.search);
    const initialQuery = urlParams.get('s') || '';

    if (initialQuery) {
      searchInput.value = initialQuery;
      const results = searchPosts(initialQuery);
      renderResults(results);
    }

    // Busca em tempo real
    let debounceTimer;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const query = e.target.value;
        const results = searchPosts(query);
        renderResults(results);

        // Atualiza URL sem recarregar
        const url = new URL(window.location);
        if (query) {
          url.searchParams.set('s', query);
        } else {
          url.searchParams.delete('s');
        }
        window.history.replaceState({}, '', url);
      }, 300);
    });

    // Previne submit e usa busca client-side
    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const query = searchInput.value;
      const results = searchPosts(query);
      renderResults(results);

      const url = new URL(window.location);
      if (query) {
        url.searchParams.set('s', query);
      } else {
        url.searchParams.delete('s');
      }
      window.history.pushState({}, '', url);
    });
  }

  // Inicializa quando o DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
