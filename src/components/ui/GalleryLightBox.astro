---
// @ts-expect-error: astro-swiper does not have types
import { Swiper, SwiperWrapper, SwiperSlide } from 'astro-swiper';

interface Props {
  images: string[];
  initialIndex?: number;
}

const { images, initialIndex = 0 } = Astro.props;
const id = `gallery-${Math.random().toString(36).substr(2, 9)}`;
---

<div
  class="fixed inset-0 z-9999 flex flex-col items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-200"
  id={id}
  data-initial={initialIndex}
>
  <div class="absolute inset-0 bg-black/95 cursor-pointer overlay"></div>

  <button
    class="absolute top-4 right-4 z-10 bg-white/10 hover:bg-white/20 border-none rounded-full w-12 h-12 flex items-center justify-center cursor-pointer text-white transition-colors close-btn"
    aria-label="Fechar galeria"
  >
    <svg
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </button>

  <div class="relative z-2 w-full max-w-[90vw] h-[70vh] mb-4">
    <Swiper
      uniqueClass={`${id}-main`}
      linkToThumbUniqueClass={images.length > 1 ? `${id}-thumbnail` : undefined}
      options={{
        initialSlide: initialIndex,
        loop: false,
        speed: 150,
        effect: 'fade',
        fadeEffect: {
          crossFade: true,
        },
        keyboard: {
          enabled: true,
        },
        navigation:
          images.length > 1
            ? {
                nextEl: `.${id}-button-next`,
                prevEl: `.${id}-button-prev`,
              }
            : false,
      }}
    >
      <SwiperWrapper>
        {
          images.map((src, idx) => (
            <SwiperSlide>
              <div class="w-full h-[70vh] flex items-center justify-center">
                <img
                  src={src}
                  alt={`Imagem ${idx + 1}`}
                  class="max-w-full max-h-full object-contain"
                  loading={idx === initialIndex ? 'eager' : 'lazy'}
                />
              </div>
            </SwiperSlide>
          ))
        }
      </SwiperWrapper>
    </Swiper>

    {
      images.length > 1 && (
        <>
          <button
            class={`${id}-button-prev absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-white/10 hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed border-none rounded-full w-12 h-12 flex items-center justify-center cursor-pointer text-white transition-colors`}
            aria-label="Imagem anterior"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="15 18 9 12 15 6" />
            </svg>
          </button>

          <button
            class={`${id}-button-next absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-white/10 hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed border-none rounded-full w-12 h-12 flex items-center justify-center cursor-pointer text-white transition-colors`}
            aria-label="PrÃ³xima imagem"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
        </>
      )
    }
  </div>

  {
    images.length > 1 && (
      <div class="relative z-10 w-full max-w-[90vw] px-3 py-2 bg-black/50 rounded-xl">
        <Swiper
          uniqueClass={`${id}-thumbnail`}
          options={{
            initialSlide: initialIndex,
            slidesPerView: 'auto',
            spaceBetween: 8,
            freeMode: true,
            watchSlidesProgress: true,
            breakpoints: {
              320: { slidesPerView: 4 },
              640: { slidesPerView: 6 },
              1024: { slidesPerView: 8 },
            },
          }}
        >
          <SwiperWrapper>
            {images.map((src, idx) => (
              <SwiperSlide>
                <div class="w-[60px] h-[60px] md:w-[70px] md:h-[70px] cursor-pointer rounded-lg overflow-hidden border-2 border-transparent transition-colors hover:border-white/50">
                  <img
                    src={src}
                    alt={`Thumbnail ${idx + 1}`}
                    class="w-full h-full object-cover"
                    loading="lazy"
                  />
                </div>
              </SwiperSlide>
            ))}
          </SwiperWrapper>
        </Swiper>
      </div>
    )
  }
</div>

<script define:vars={{ id }}>
  const gallery = document.getElementById(id);
  const overlay = gallery.querySelector('.overlay');
  const closeBtn = gallery.querySelector('.close-btn');

  function close() {
    gallery.classList.remove('open');
    gallery.classList.add('opacity-0', 'pointer-events-none');
    document.body.style.overflow = '';
  }

  function open() {
    gallery.classList.add('open');
    gallery.classList.remove('opacity-0', 'pointer-events-none');
    document.body.style.overflow = 'hidden';
  }

  // Event listeners
  overlay.addEventListener('click', close);
  closeBtn.addEventListener('click', close);

  // Keyboard navigation (ESC)
  document.addEventListener('keydown', (e) => {
    if (!gallery.classList.contains('open')) return;
    if (e.key === 'Escape') close();
  });

  // Auto-open on page load
  open();
</script>
