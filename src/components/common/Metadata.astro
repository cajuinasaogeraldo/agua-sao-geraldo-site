---
import merge from 'lodash.merge';
import { AstroSeo } from '@astrolib/seo';
import { Schema } from 'astro-seo-schema';

import type { Props as AstroSeoProps } from '@astrolib/seo';

import { SITE, METADATA, I18N } from 'astrowind:config';
import { getCanonical } from '@/utils/permalinks';
import { adaptOpenGraphImages } from '@/utils/images';
import type { MetaData } from '@/types';

import ldJsonImg from '@/assets/images/site/logo.webp';

const BASE_URL = Astro.site?.origin || SITE?.site || 'https://aguasaogeraldo.com.br';
const LANGUAGE = I18N?.language || 'pt-BR';

const getAbsoluteImageUrl = (imgSrc: string) => {
  if (imgSrc.startsWith('http://') || imgSrc.startsWith('https://')) {
    return imgSrc;
  }
  return `${BASE_URL}${imgSrc.startsWith('/') ? '' : '/'}${imgSrc}`;
};

const absoluteImageUrl = getAbsoluteImageUrl(ldJsonImg.src);

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
} = Astro.props;

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: SITE?.name,
      images: [{ url: absoluteImageUrl }],
      locale: LANGUAGE,
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex: typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : undefined,
    nofollow: typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : undefined,
    description: METADATA?.description,
    openGraph: METADATA?.openGraph,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    openGraph: { url: canonical, ...openGraph },
    twitter: twitter,
  },
);

// Schema.org structured data configuration
const schemaConfig = {
  siteName: SITE?.name || 'Água São Geraldo',
  siteDescription: METADATA?.description || description || 'Água Mineral São Geraldo',
  pageTitle: seoProps.title || METADATA?.title?.default || '',
  pageDescription: seoProps.description || METADATA?.description || '',
};

const schemaGraph: unknown[] = [
  {
    '@type': 'WebPage',
    '@id': `${canonical}#webpage`,
    url: canonical,
    name: schemaConfig.pageTitle,
    isPartOf: { '@id': `${BASE_URL}#website` },
    primaryImageOfPage: { '@id': `${BASE_URL}#primary-image` },
    image: { '@id': `${BASE_URL}#primary-image` },
    thumbnailUrl: absoluteImageUrl,
    datePublished: '2017-06-14T09:23:16+00:00',
    dateModified: new Date().toISOString(),
    description: schemaConfig.pageDescription,
    inLanguage: LANGUAGE,
    potentialAction: [{ '@type': 'ReadAction', target: [canonical] }],
  },
  {
    '@type': 'ImageObject',
    '@id': `${BASE_URL}#primary-image`,
    inLanguage: LANGUAGE,
    url: absoluteImageUrl,
    contentUrl: absoluteImageUrl,
    width: 512,
    height: 512,
    caption: `Logo ${schemaConfig.siteName}`,
  },
  {
    '@type': 'WebSite',
    '@id': `${BASE_URL}#website`,
    url: BASE_URL,
    name: schemaConfig.siteName,
    description: schemaConfig.siteDescription,
    inLanguage: LANGUAGE,
    potentialAction: [
      {
        '@type': 'SearchAction',
        target: `${BASE_URL}/busca?s={search_term_string}`,
        'query-input': 'required name=search_term_string',
      },
    ],
  },
];
---

<>
  <AstroSeo
    {...{
      ...seoProps,
      openGraph: await adaptOpenGraphImages(seoProps?.openGraph, Astro.site),
    }}
  />
  <Schema
    item={{
      '@context': 'https://schema.org',
      // @ts-expect-error unknown != Thing | Thing[].
      '@graph': schemaGraph,
    }}
  />
</>
