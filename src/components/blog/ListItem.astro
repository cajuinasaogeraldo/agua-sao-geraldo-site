---
import type { ImageMetadata } from 'astro';
import Image from '@/components/common/Image.astro';

import { APP_BLOG } from 'astrowind:config';
import type { News } from '@/types';

import { getPermalink } from '@/utils/permalinks';
import { findImage } from '@/utils/images';
import { getFormattedDate } from '@/utils/utils';

export interface Props {
  news: News;
}

const { news } = Astro.props;
const image = (await findImage(news.image)) as ImageMetadata | undefined;

const link = APP_BLOG?.post?.isEnabled ? getPermalink(news.permalink, 'news') : '';
---

<article
  class="border border-gray-200 rounded-lg overflow-hidden transition-all hover:shadow-lg hover:border-agua-primary-blue/30 p-4 md:p-6 bg-white"
>
  <div
    class={`grid items-center gap-3 ${image ? 'md:grid-cols-[minmax(220px,300px)_1fr]' : ''} md:gap-4`}
  >
    <a href={link} class="block overflow-hidden rounded-md w-full">
      <Image
        src={image}
        class="aspect-square! w-full transition-transform duration-300 hover:scale-105"
        widths={[400, 900]}
        width={900}
        sizes="(max-width: 900px) 400px, 900px"
        alt={news.title}
        loading="lazy"
        decoding="async"
      />
    </a>
    <div class="flex flex-col">
      {
        news.category && (
          <span class="text-agua-primary-blue text-xs font-medium uppercase mb-1 inline-block">
            {news.category.title}
          </span>
        )
      }
      <div class="text-muted text-xs flex items-center gap-2 mb-1.5">
        <time datetime={String(news.publishDate)}>{getFormattedDate(news.publishDate)}</time>
        {news.author && <span>• {news.author.replaceAll('-', ' ')}</span>}
        {news.readingTime && <span>• {news.readingTime} min</span>}
      </div>
      <h3 class="mb-2 font-bold">
        {
          link ? (
            <a
              href={link}
              class="text-agua-primary-green! hover:text-agua-secondary-green! transition-colors line-clamp-2 md:line-clamp-3"
            >
              {news.title}
            </a>
          ) : (
            <span class="line-clamp-2 md:line-clamp-3">{news.title}</span>
          )
        }
      </h3>
      {
        news.excerpt && (
          <p class="text-muted text-sm mb-2 leading-relaxed line-clamp-3">{news.excerpt}</p>
        )
      }
      {
        news.tags && Array.isArray(news.tags) && news.tags.length > 0 && (
          <div class="flex flex-wrap gap-1.5">
            {news.tags.map((tag) => (
              <a
                href={getPermalink(tag.slug, 'tag')}
                class="bg-agua-primary-blue text-white! px-2.5 py-1 md:px-3 md:py-1.5 rounded-full text-sm md:text-base font-medium hover:bg-agua-secondary-blue/80 transition-colors"
              >
                #{tag.title}
              </a>
            ))}
          </div>
        )
      }
    </div>
  </div>
</article>
